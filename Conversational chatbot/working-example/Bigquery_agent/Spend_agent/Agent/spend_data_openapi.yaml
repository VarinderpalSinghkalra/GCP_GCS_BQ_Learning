openapi: 3.0.0

info:
  title: Spend Analytics Structured Data API
  version: "1.0.0"
  description: >
    Rule-based spend analytics API backed by BigQuery structured data.
    Designed for Vertex AI Conversational Agents.

    The agent sends a natural language question.
    SQL is generated, validated, and executed server-side.
    The model never generates or executes SQL.

servers:
  - url: https://FUNCTION_URL_HERE

paths:
  /:
    post:
      summary: Ask a spend analytics question
      operationId: askSpendAnalytics
      description: >
        Accepts a natural language analytics question.
        The backend safely generates SQL, validates it against
        an allow-listed schema, executes it on BigQuery,
        and returns structured results.

      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - question
              properties:
                question:
                  type: string
                  minLength: 5
                  description: >
                    Natural language spend analytics question.
                    Example: "What is total spend by category in the last 12 months?"
                  example: What is total spend by category last year?

      responses:
        "200":
          description: Successful analytics response
          content:
            application/json:
              schema:
                type: object
                required:
                  - question
                  - sql
                  - rows
                  - confidence_score
                  - warnings
                  - cache_size
                properties:
                  question:
                    type: string
                    description: Original user question

                  sql:
                    type: string
                    description: >
                      Server-generated SQL used to answer the question.
                      Returned for transparency and debugging.
                      Not generated by the model.

                  rows:
                    type: array
                    description: Result rows returned from BigQuery
                    items:
                      type: object
                      additionalProperties: true

                  confidence_score:
                    type: number
                    format: float
                    minimum: 0
                    maximum: 1
                    description: >
                      Confidence score based on query structure
                      (grouping, safe casting, date handling).

                  warnings:
                    type: array
                    description: Non-fatal interpretation warnings
                    items:
                      type: string

                  cache_size:
                    type: integer
                    description: Current in-memory query cache size

        "400":
          description: Invalid request (missing or empty question)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

        "500":
          description: Internal execution error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
