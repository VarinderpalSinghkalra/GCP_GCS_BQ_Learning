SERVICE ACCOUNT SETUP – CONVERSATIONAL AGENT TOOL (GCP)

Project: platform-support-analyst-57565
Region: us-central1
Service Type: Cloud Run / Cloud Functions Gen2
Purpose: Backend execution for Conversational Agent tool (Issue Management API)

--------------------------------------------------
1. WHY SERVICE ACCOUNT IS REQUIRED
--------------------------------------------------
Conversational Agents do not execute backend code as a user.
All tool invocations run under a GCP service account.

If the service account lacks required permissions:
- Firestore writes fail
- Vertex AI (Gemini) calls fail
- Backend throws exception
- Agent shows fallback response with "issue_id": "ERROR"

--------------------------------------------------
2. IDENTIFY RUNTIME SERVICE ACCOUNT
--------------------------------------------------

Cloud Functions Gen2:
gcloud functions describe submit_issue \
  --gen2 \
  --region us-central1 \
  --format="value(serviceConfig.serviceAccountEmail)"

Cloud Run:
gcloud run services describe issue-management-api \
  --region us-central1 \
  --format="value(spec.template.spec.serviceAccountName)"

The returned email is the ONLY service account that matters.

--------------------------------------------------
3. CREATE DEDICATED SERVICE ACCOUNT (RECOMMENDED)
--------------------------------------------------

gcloud iam service-accounts create platform-support-sa \
  --project=platform-support-analyst-57565 \
  --description="Service account for platform support bot" \
  --display-name="Platform Support Bot SA"

Service account email:
platform-support-sa@platform-support-analyst-57565.iam.gserviceaccount.com

--------------------------------------------------
4. ATTACH SERVICE ACCOUNT TO RUNTIME
--------------------------------------------------

Cloud Run:
gcloud run services update issue-management-api \
  --service-account=platform-support-sa@platform-support-analyst-57565.iam.gserviceaccount.com \
  --region us-central1

Cloud Functions Gen2:
gcloud functions deploy submit_issue \
  --gen2 \
  --runtime python311 \
  --region us-central1 \
  --service-account=platform-support-sa@platform-support-analyst-57565.iam.gserviceaccount.com \
  --trigger-http \
  --allow-unauthenticated

--------------------------------------------------
5. REQUIRED IAM ROLES
--------------------------------------------------

Firestore (Issue storage):
gcloud projects add-iam-policy-binding platform-support-analyst-57565 \
  --member="serviceAccount:platform-support-sa@platform-support-analyst-57565.iam.gserviceaccount.com" \
  --role="roles/datastore.user"

Vertex AI (Gemini access):
gcloud projects add-iam-policy-binding platform-support-analyst-57565 \
  --member="serviceAccount:platform-support-sa@platform-support-analyst-57565.iam.gserviceaccount.com" \
  --role="roles/aiplatform.user"

Logging (Debugging):
gcloud projects add-iam-policy-binding platform-support-analyst-57565 \
  --member="serviceAccount:platform-support-sa@platform-support-analyst-57565.iam.gserviceaccount.com" \
  --role="roles/logging.logWriter"

--------------------------------------------------
6. ENABLE REQUIRED APIS (ONE-TIME)
--------------------------------------------------

gcloud services enable firestore.googleapis.com
gcloud services enable aiplatform.googleapis.com
gcloud services enable cloudfunctions.googleapis.com
gcloud services enable run.googleapis.com
gcloud services enable logging.googleapis.com

--------------------------------------------------
7. FIRESTORE VALIDATION
--------------------------------------------------

Console → Firestore → Databases

Requirements:
- Firestore mode: Native
- Database initialized
- Region selected

If Firestore is not initialized, all writes will fail.

--------------------------------------------------
8. VERIFY IAM BINDINGS
--------------------------------------------------

gcloud projects get-iam-policy platform-support-analyst-57565 \
  --flatten="bindings[].members" \
  --filter="bindings.members:platform-support-sa@platform-support-analyst-57565.iam.gserviceaccount.com" \
  --format="table(bindings.role)"

Expected roles:
- roles/datastore.user
- roles/aiplatform.user
- roles/logging.logWriter

--------------------------------------------------
9. LOG VERIFICATION
--------------------------------------------------

Cloud Functions Gen2:
gcloud functions logs read submit_issue --gen2 --region us-central1

Cloud Run:
gcloud run services logs read issue-management-api --region us-central1

IAM issues appear as:
PERMISSION_DENIED
or
API not enabled

--------------------------------------------------
10. SUCCESS STATE
--------------------------------------------------

When IAM and APIs are correct, tool output returns:

{
  "issue_id": "INC-XXXXXXX",
  "status": "created",
  "assistant_reply": "Your issue has been logged successfully."
}

No fallback response.
No internal error.

--------------------------------------------------
SUMMARY
--------------------------------------------------
- Conversational Agents rely entirely on service account IAM
- Backend code can be correct and still fail due to permissions
- Always identify and fix the runtime service account
- Use least-privilege IAM for production
